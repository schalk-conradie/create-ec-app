# EC Power Pages Single Page Application (SPA)

This is a Power Pages Single Page Application (SPA) built with React, Vite, and TypeScript, generated by `create-ec-app`. It follows Microsoft’s official Power Pages code site model, providing a modern, scalable, and maintainable frontend architecture tailored specifically for Power Pages environments. The app includes integrated authentication, data fetching, and UI options designed to work seamlessly within the Power Pages runtime.

## Features

- **React + Vite + TypeScript**: Modern frontend stack for fast development and optimized builds.
- **Tailwind CSS**: Utility-first CSS framework with an optional Kendo UI preset for styling consistency.
- **UI Library Choice**: Select between Kendo UI (including theme selection) or Shadcn/ui components.
- **TanStack Query**: Preconfigured React Query provider for efficient data fetching and caching.
- **Power Pages AuthContext**: Integrated authentication context that detects the Power Pages user (`Microsoft.Dynamics365.Portal.User`) and retrieves tokens via `window.shell.getTokenDeferred()`.
- **Local Development Support**: Includes a mock token file and configuration to simulate authentication during local development.
- **Optimized Vite Build Output**: Builds optimized assets tailored for upload to Power Pages code sites.

## Auth and API Access

This SPA integrates with Power Pages authentication and API access mechanisms. The `AuthContext` handles user detection and token retrieval using the Power Pages runtime API. Tokens are obtained asynchronously through `window.shell.getTokenDeferred()`, enabling authenticated API calls to Power Pages endpoints.

### Example: API URL and Auth Headers

Here is an example of utility functions to build API URLs and set authentication headers for requests within the Power Pages SPA:

```ts
// src/utils/api.ts

export function getApiUrl(entity: string, query = ''): string {
  // Base path for Power Pages API (adjust if your site uses a different base)
  const baseUrl = '/_api';
  return `${baseUrl}/${entity}${query ? `?${query}` : ''}`;
}

export function getAuthHeaders(token: string) {
  return {
    Authorization: `Bearer ${token}`,
    'Content-Type': 'application/json',
    Accept: 'application/json',
  };
}
```

### Azure CLI Token Generation for Local Development

For local development and debugging outside the Power Pages runtime, you can generate an Azure AD token using the Azure CLI. This token can be used to simulate authenticated requests against your Power Pages environment:

```bash
az account get-access-token --resource=https://<your-powerpages-environment>.crm.dynamics.com
```

Replace `<your-powerpages-environment>` with your actual environment URL. Use the obtained token in your local mock token file or directly in API request headers.

## Example Service Using TanStack Query

Here is an example of a service module `src/services/contacts.ts` that demonstrates fetching contacts data from the Power Pages API using TanStack Query:

```ts
// src/services/contacts.ts
import { useQuery } from '@tanstack/react-query';
import { getApiUrl, getAuthHeaders } from '@/utils/api';
import { useAuth } from '@/context/AuthContext';

export interface Contact {
  contactid: string;
  firstname: string;
  lastname: string;
  emailaddress1?: string;
}

async function fetchContacts(token: string): Promise<Contact[]> {
  const response = await fetch(getApiUrl('contacts'), {
    headers: getAuthHeaders(token),
  });
  if (!response.ok) {
    throw new Error('Failed to fetch contacts');
  }
  const data = await response.json();
  return data.value;
}

export function useContacts() {
  const { token } = useAuth();

  return useQuery(['contacts'], () => fetchContacts(token!), {
    enabled: !!token,
  });
}
```

This pattern leverages the `AuthContext` to access the current token and uses TanStack Query to manage caching and background updates.

## Deployment

To deploy your Power Pages SPA:

- Build the project using `npm run build` or `npm run build:dev` for development builds.
- Upload the contents of the `dist` folder to your Power Pages site’s **code site**. This is a dedicated location for hosting SPA assets as static content.
- Reference your built JavaScript and CSS files in your Power Pages pages as needed.

For detailed guidance on Power Pages code sites and deployment, see the [Microsoft Power Pages documentation on code sites](https://learn.microsoft.com/en-us/power-pages/developer/code-sites).

Power Pages code sites support continuous deployment workflows via the Power Platform CLI, enabling streamlined updates and integration with source control.

## Configuration

The `powerpages.config.json` file defines your site configuration, including output paths and landing page settings. Adjust this file to match your project and deployment conventions.

---

This SPA template provides a robust foundation for building Power Pages applications with modern web development tools and best practices, ensuring smooth integration with the Power Pages platform and scalable, maintainable code.
