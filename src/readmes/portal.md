# EC Portal App

Next.js (App Router) + TypeScript template for customer portals integrated with Dynamics 365/Dataverse. Generated by `create-ec-app`, it includes Tailwind CSS, TanStack Query, Azure AD authentication via NextAuth, and a choice of UI library (Kendo UI or Shadcn/ui).

## Features

- Next.js App Router with TypeScript
- Tailwind CSS; Kendo preset applied when using Kendo UI
- UI choice: Kendo UI (with theme import) or Shadcn/ui
- TanStack Query provider (`src/app/providers.tsx`)
- Azure AD auth via NextAuth (`auth.ts`, `src/app/api/auth/[...nextauth]/route.ts`)
- Example Dynamics API route (`src/app/api/dynamics/accounts/route.ts`)
- React Query hook (`src/hooks/useDynamicsAccounts.ts`)
- `next.config.ts` set to `output: 'standalone'` (Azure-friendly)
- Example GitHub Actions workflow (`github.example.deploy.yml`)
- Example Azure DevOps pipeline (`azure-pipelines.example.yml`)

## Prerequisites

- Node.js 18+ and npm 9+
- Azure AD app registration (client id/secret, tenant)
- Dynamics 365/Dataverse environment and base URL

## Getting Started

1. Install dependencies: `npm install`

2. Configure environment in `.env.local`:

```
NEXTAUTH_URL=http://localhost:3000
AZURE_AD_CLIENT_ID=your-azure-ad-client-id
AZURE_AD_CLIENT_SECRET=your-azure-ad-client-secret
AZURE_AD_TENANT_ID=your-azure-ad-tenant-id
DYNAMICS_BASE_URL=https://your-org.crm.dynamics.com
DYNAMICS_API_VERSION=v9.2
```

3. Development: `npm run dev`

4. Production build: `npm run build` then `npm start`

If you selected Kendo UI, activate your license after install:

```
npx kendo-ui-license activate
```

## Dynamics Data Access

- Library: `src/lib/dynamics.ts` exposes `getDynamicsData(entity, options)`
- API route: `src/app/api/dynamics/accounts/route.ts` fetches Accounts via the above
- Hook: `src/hooks/useDynamicsAccounts.ts` wraps the API with TanStack Query

Example component:

```tsx
"use client";
import { useDynamicsAccounts } from "@/hooks/useDynamicsAccounts";

export default function AccountsList() {
	const { data, isLoading, error } = useDynamicsAccounts();
	if (isLoading) return <div>Loading…</div>;
	if (error) return <div>Failed to load</div>;
	return (
		<ul>
			{data?.map((a) => (
				<li key={a.accountid}>{a.name}</li>
			))}
		</ul>
	);
}
```

## UI Libraries

- Kendo UI: Theme CSS is imported in `src/app/layout.tsx` and components can be used from `@progress/kendo-react-*` packages.
- Shadcn/ui: Components are installed and available via the `@/components` alias.

## Deployment

- The project is configured for standalone output (good for Azure App Service and containers).
- An example GitHub Actions workflow is provided in `example.deploy.yml`. Configure secrets and adapt steps to your environment.

### Azure App Service (Web App)

Step 1 — Create a Web App and connect CI

- Create a new App Service in Azure and connect deployment to your repository (GitHub) or set up an Azure DevOps pipeline.

Step 2 — Environment variables

It is important to set configuration early to avoid restarts due to missing settings. Ensure you set the following app settings. Note the `SCM_DO_BUILD_DURING_DEPLOYMENT` flag controls whether App Service attempts a build during deployment.

Example app settings payload:

```
[
  {
    "name": "AUTH_MICROSOFT_ENTRA_ID_ID",
    "value": "",
    "slotSetting": false
  },
  {
    "name": "AUTH_MICROSOFT_ENTRA_ID_ISSUER",
    "value": "<https://login.microsoftonline.com/TENANT_ID/v2.0>",
    "slotSetting": false
  },
  {
    "name": "AUTH_MICROSOFT_ENTRA_ID_SECRET",
    "value": "CLIENT_SECRET",
    "slotSetting": false
  },
  {
    "name": "AUTH_MICROSOFT_ENTRA_ID_TENANT_ID",
    "value": "TENANT_ID",
    "slotSetting": false
  },
  {
    "name": "AUTH_SECRET",
    "value": "AUTH_SECRET",
    "slotSetting": false
  },
  {
    "name": "AUTH_URL",
    "value": "https://WEBSITE_URL/",
    "slotSetting": false
  },
  {
    "name": "DYNAMICS_API_URL",
    "value": "https://DYNAMICS_URL/",
    "slotSetting": false
  },
  {
    "name": "NEXT_PUBLIC_BASE_URL",
    "value": "https://BASE_URL",
    "slotSetting": false
  },
  {
    "name": "SCM_DO_BUILD_DURING_DEPLOYMENT",
    "value": "false",
    "slotSetting": false
  }
]
```

Notes:

- If your CI pipeline builds the app and you deploy the standalone output, set `SCM_DO_BUILD_DURING_DEPLOYMENT` to `false` to prevent an extra App Service build.
- If you push source and want App Service (Kudu/Oryx) to build, set `SCM_DO_BUILD_DURING_DEPLOYMENT` to `true`.
- This template’s `auth.ts` uses `AZURE_AD_CLIENT_ID|SECRET|TENANT_ID`. If you prefer Auth.js environment variable names (`AUTH_MICROSOFT_ENTRA_ID_*`), update `auth.ts` accordingly or map the variables in your deployment.

Step 3 — Startup command

- In App Service > Settings > Configuration, set Startup command:

```
node server.js
```

- This ensures the standalone Next.js server is launched on startup. Without it, you may see “next not found” in Log Stream and an Application Error on launch.
