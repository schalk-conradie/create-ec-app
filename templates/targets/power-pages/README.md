# EC Power Pages Single Page Application (SPA)

This is a Power Pages Single Page Application (SPA) built with React, Vite, and TypeScript, generated by `create-ec-app`. It follows Microsoft’s official Power Pages code site model, providing a modern, scalable, and maintainable frontend architecture tailored specifically for Power Pages environments. The app includes integrated authentication, data fetching, and UI options designed to work seamlessly within the Power Pages runtime.

## Features

- **React + Vite + TypeScript**: Modern frontend stack for fast development and optimized builds.
- **Tailwind CSS**: Utility-first CSS framework with an optional Kendo UI preset for styling consistency.
- **UI Library Choice**: Select between Kendo UI (including theme selection) or Shadcn/ui components.
- **TanStack Query**: Preconfigured React Query provider for efficient data fetching and caching.
- **ADAL Authentication**: Integrated Azure Active Directory Authentication Library (ADAL) for Entra ID authentication with token caching.
- **Local Development Support**: Full authentication support during local development using ADAL
- **Optimized Vite Build Output**: Builds optimized assets tailored for upload to Power Pages code sites.

## Auth and API Access

This SPA uses ADAL (Azure Active Directory Authentication Library) for authentication. While ADAL is deprecated by Microsoft, it remains functional for Power Pages scenarios until MSAL v2 support is available.

### Authentication Setup

The `AuthContext` requires the following environment variables:

- `VITE_AAD_TENANT_ID`: Your Azure AD tenant ID (defaults to "common")
- `VITE_AAD_CLIENT_ID`: Your Azure AD application (client) ID (required)
- `VITE_AUTH_DEBUG`: Optional, set to "true" for verbose authentication logging

### How It Works

1. **Script Loading**: ADAL is dynamically loaded from Microsoft's CDN (`https://secure.aadcdn.microsoftonline-p.com/lib/1.0.17/js/adal.min.js`)
2. **Token Caching**: Authentication tokens are cached in localStorage for persistence
3. **User Information**: The authenticated user object includes `userName`, `displayableId`, `name`, `givenName`, `familyName`, and `idToken`
4. **Token Retrieval**: Access ID tokens via the `getIdToken()` method from the auth context

### Authentication Flow

- When users call `login()`, they're redirected to Azure AD for authentication
- After successful authentication, users are redirected back with tokens
- Tokens are automatically cached and reused for subsequent requests
- Call `logout()` to clear tokens and sign out the user

## Example Data Fetch Using TanStack Query and AuthContext

Here is an example of a service module `src/services/contacts.ts` that demonstrates fetching contacts data from the Power Pages API using TanStack Query:

```ts
import { useQuery } from "@tanstack/react-query";
import { AuthButton } from "./components/shared/AuthButton";
import { useAuth } from "./context/AuthContext";

type Account = {
 name: string | null;
 accountnumber: string | null;
 accountid: string;
};

function App() {
 const { isAuthenticated, user } = useAuth();

 const { data: accounts, isLoading } = useQuery({
  queryKey: ["accounts"],
  queryFn: async () => {
   const response = await fetch(
    `_api/accounts?$select=name,accountnumber&$top=5`,
    {
     method: "GET",
     headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${user?.idToken}`,
     },
    }
   );

   if (!response.ok) {
    throw new Error("Network response was not ok");
   }
   return response.json();
  },
  enabled: isAuthenticated && !!user,
 });

 if (isLoading) {
  return (
   <div className="flex flex-col items-center justify-center h-screen">
    <div>Loading...</div>
   </div>
  );
 }

 return (
  <div className="flex flex-col items-center justify-center h-screen gap-4">
   {accounts ? (
    <div>
     <h2 className="mb-4 text-xl font-bold">Accounts:</h2>
     <ul className="list-disc list-inside">
      {accounts.value.map((account: Account) => (
       <li key={account.accountid}>
        {account.name} - {account.accountnumber}
       </li>
      ))}
     </ul>
    </div>
   ) : (
    <div>
     {isAuthenticated ? (
      <div>No accounts data available.</div>
     ) : (
      <>
       <div>Please log in to view your accounts.</div>
       <AuthButton />
      </>
     )}
    </div>
   )}
  </div>
 );
}

export default App;
```

## Creating an Auth Button

```tsx
import { useAuth } from "@/context/AuthContext";
import { Button } from "../ui/button";

export const AuthButton = () => {
  const { isAuthenticated, user, login, logout } = useAuth();
  const displayName = user?.name || user?.userName || user?.givenName || "";

  return (
    <div className="flex flex-col items-center gap-4">
      {isAuthenticated ? (
        <>
          {displayName && <span>Welcome {displayName}</span>}
          <Button variant="default" onClick={logout}>
            Sign Out
          </Button>
        </>
      ) : (
        <Button onClick={login} variant="outline">
          Sign In
        </Button>
      )}
    </div>
  );
};
```

## UI Libraries

- Kendo UI: Theme CSS is imported in `src/main.tsx`. Example:

  ```tsx
  import { Button } from "@progress/kendo-react-buttons";
  <Button>Click me</Button>;
  ```

- Shadcn/ui: Components are installed and available under the `@/components` alias. Example:

  ```tsx
  import { Button } from "@/components/ui/button";
  <Button>Click me</Button>;
  ```

## Deployment

To deploy your Power Pages SPA:

- Build the project using `npm run build` or `npm run build:dev` for development builds.
- Upload the contents of the `dist` folder to your Power Pages site’s **code site**. This is a dedicated location for hosting SPA assets as static content.
- Reference your built JavaScript and CSS files in your Power Pages pages as needed.

For detailed guidance on Power Pages code sites and deployment, see the [Microsoft Power Pages documentation on code sites](https://learn.microsoft.com/en-us/power-pages/developer/code-sites).

Power Pages code sites support continuous deployment workflows via the Power Platform CLI, enabling streamlined updates and integration with source control.

## Configuration

The `powerpages.config.json` file defines your site configuration, including output paths and landing page settings. Adjust this file to match your project and deployment conventions.
