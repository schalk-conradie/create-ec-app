# EC Power Pages Single Page Application (SPA)

This is a Power Pages Single Page Application (SPA) built with React, Vite, and TypeScript, generated by `create-ec-app`. It follows Microsoft’s official Power Pages code site model, providing a modern, scalable, and maintainable frontend architecture tailored specifically for Power Pages environments. The app includes integrated authentication, data fetching, and UI options designed to work seamlessly within the Power Pages runtime.

## Features

- **React + Vite + TypeScript**: Modern frontend stack for fast development and optimized builds.
- **Tailwind CSS**: Utility-first CSS framework with an optional Kendo UI preset for styling consistency.
- **UI Library Choice**: Select between Kendo UI (including theme selection) or Shadcn/ui components.
- **TanStack Query**: Preconfigured React Query provider for efficient data fetching and caching.
- **Power Pages AuthContext**: Integrated authentication context that detects the Power Pages user (`Microsoft.Dynamics365.Portal.User`) and retrieves tokens via `window.shell.getTokenDeferred()`.
- **Local Development Support**: Makes use of ADAL to to log in and proxy requests onto the deployed site
- **Optimized Vite Build Output**: Builds optimized assets tailored for upload to Power Pages code sites.

## Auth and API Access

This SPA integrates with Power Pages authentication and API access mechanisms. The `AuthContext` handles user detection and token retrieval using the Power Pages runtime API. Tokens are obtained asynchronously through `window.shell.getTokenDeferred()`, enabling authenticated API calls to Power Pages endpoints.

## Example Data Fetch Using TanStack Query and AuthContext

Here is an example of a service module `src/services/contacts.ts` that demonstrates fetching contacts data from the Power Pages API using TanStack Query:

```ts
import { useQuery } from "@tanstack/react-query";
import { AuthButton } from "./components/shared/AuthButton";
import { useAuth } from "./context/AuthContext";

type Account = {
 name: string | null;
 accountnumber: string | null;
 accountid: string;
};

function App() {
 const { isAuthenticated, user } = useAuth();

 const { data: accounts, isLoading } = useQuery({
  queryKey: ["accounts"],
  queryFn: async () => {
   const response = await fetch(
    `_api/accounts?$select=name,accountnumber&$top=5`,
    {
     method: "GET",
     headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${user?.idToken}`,
     },
    }
   );

   if (!response.ok) {
    throw new Error("Network response was not ok");
   }
   return response.json();
  },
  enabled: isAuthenticated && !!user,
 });

 if (isLoading) {
  return (
   <div className="flex flex-col items-center justify-center h-screen">
    <div>Loading...</div>
   </div>
  );
 }

 return (
  <div className="flex flex-col items-center justify-center h-screen gap-4">
   {accounts ? (
    <div>
     <h2 className="mb-4 text-xl font-bold">Accounts:</h2>
     <ul className="list-disc list-inside">
      {accounts.value.map((account: Account) => (
       <li key={account.accountid}>
        {account.name} - {account.accountnumber}
       </li>
      ))}
     </ul>
    </div>
   ) : (
    <div>
     {isAuthenticated ? (
      <div>No accounts data available.</div>
     ) : (
      <>
       <div>Please log in to view your accounts.</div>
       <AuthButton />
      </>
     )}
    </div>
   )}
  </div>
 );
}

export default App;
```

## Creating an Auth Button

```tsx
import { useAuth } from "@/context/AuthContext";
import { Button } from "../ui/button";

export const AuthButton = () => {
  const { isAuthenticated, user, login, logout } = useAuth();
  const displayName = user?.name || user?.userName || user?.givenName || "";

  return (
    <div className="flex flex-col items-center gap-4">
      {isAuthenticated ? (
        <>
          {displayName && <span>Welcome {displayName}</span>}
          <Button variant="default" onClick={logout}>
            Sign Out
          </Button>
        </>
      ) : (
        <Button onClick={login} variant="outline">
          Sign In
        </Button>
      )}
    </div>
  );
};
```

## UI Libraries

- Kendo UI: Theme CSS is imported in `src/main.tsx`. Example:

  ```tsx
  import { Button } from "@progress/kendo-react-buttons";
  <Button>Click me</Button>;
  ```

- Shadcn/ui: Components are installed and available under the `@/components` alias. Example:

  ```tsx
  import { Button } from "@/components/ui/button";
  <Button>Click me</Button>;
  ```

## Deployment

To deploy your Power Pages SPA:

- Build the project using `npm run build` or `npm run build:dev` for development builds.
- Upload the contents of the `dist` folder to your Power Pages site’s **code site**. This is a dedicated location for hosting SPA assets as static content.
- Reference your built JavaScript and CSS files in your Power Pages pages as needed.

For detailed guidance on Power Pages code sites and deployment, see the [Microsoft Power Pages documentation on code sites](https://learn.microsoft.com/en-us/power-pages/developer/code-sites).

Power Pages code sites support continuous deployment workflows via the Power Platform CLI, enabling streamlined updates and integration with source control.

## Configuration

The `powerpages.config.json` file defines your site configuration, including output paths and landing page settings. Adjust this file to match your project and deployment conventions.
